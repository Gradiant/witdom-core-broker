FROM node:argon

# Create app directory
RUN mkdir -p /usr/src/broker
WORKDIR /usr/src/broker

# Copy and install app dependencies
COPY dependencies/iam/keystone-clients/javascript-wrappers/node-openstack-token-utils/. dependencies/iam/keystone-clients/javascript-wrappers/node-openstack-token-utils
COPY package.json /usr/src/broker
COPY orchestration/. orchestration/
RUN npm install

# Bundle app source
COPY broker.js ./
COPY api/. api/
COPY config/. config/
COPY broker_ud_custom_config.js config/custom.js
COPY controllers/. controllers/
COPY models/. models/
COPY utils/. utils/
COPY certs/broker_ud* certs/
COPY certs/witdomcacert.pem certs/
COPY validators/. validators/
COPY service_info/. service_info/
COPY request_forwarding/. request_forwarding/
COPY protection/. protection/
COPY tests/. tests/
COPY CAs/. CAs/

EXPOSE 5000
EXPOSE 5043

CMD [ "npm", "start" ]

# For the image build: $ docker build -f Dockerfile_ud -t witdom-core-broker-ud .
# For the container run: $ docker run --name broker_ud -p 5100:5000 -p 5143:5043 --link mongo-container-name:mongo -d witdom-core-broker-ud